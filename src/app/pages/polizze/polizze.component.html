<div class="container">
  <div class="header">
    <h1>Gestione Polizze</h1>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <i class="icon-plus"></i>
      Nuova Polizza
    </button>
  </div>

  <!-- Filtri -->
  <div class="filters">
    <div class="filter-group">
      <label for="search">Cerca:</label>
      <input
        id="search"
        type="text"
        placeholder="Numero polizza, assicurato, CF..."
        [value]="searchTerm()"
        (input)="onSearchChange($event)"
        class="form-control">
    </div>

    <div class="filter-group">
      <label for="tipo">Tipo:</label>
      <select
        id="tipo"
        [value]="filterTipo()"
        (change)="onTipoFilterChange($event)"
        class="form-control">
        <option value="all">Tutti i tipi</option>
        @for (tipo of tipiPolizza(); track tipo.id_tipo_polizza) {
          <option [value]="tipo.id_tipo_polizza">{{ tipo.descrizione }}</option>
        }
      </select>
    </div>

    <div class="filter-group">
      <label for="stato">Stato:</label>
      <select
        id="stato"
        [value]="filterStato()"
        (change)="onStatoFilterChange($event)"
        class="form-control">
        <option value="all">Tutti gli stati</option>
        @for (stato of statiPolizza(); track stato.id_stato_polizza) {
          <option [value]="stato.id_stato_polizza">{{ stato.descrizione }}</option>
        }
      </select>
    </div>

    <div class="filter-group">
      <label for="scadenza">Scadenza:</label>
      <select
        id="scadenza"
        [value]="filterScadenza()"
        (change)="onScadenzaFilterChange($event)"
        class="form-control">
        <option value="all">Tutte</option>
        <option value="valida">Valide</option>
        <option value="in_scadenza">In Scadenza</option>
        <option value="scaduta">Scadute</option>
      </select>
    </div>
  </div>

  <!-- Tabella Polizze -->
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>Numero Polizza</th>
          <th>Assicurato</th>
          <th>Tipo</th>
          <th>Periodo</th>
          <th>Stato</th>
          <th>Premio Annuale</th>
          <th>Massimale/Franchigia</th>
          <th>Utilizzo</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody>
        @for (polizza of filteredPolizze(); track polizza.id_polizza) {
          <tr>
            <td class="code">{{ polizza.numero_polizza }}</td>
            <td>
              <div class="assicurato-cell">
                <strong>{{ polizza.assicurato }}</strong>
                <small>{{ polizza.codice_fiscale }}</small>
              </div>
            </td>
            <td>
              <span [class]="'badge ' + getTipoBadgeClass(polizza.tipo_polizza)">
                {{ polizza.tipo_polizza }}
              </span>
            </td>
            <td>
              <div class="periodo-cell">
                <div class="date-range">
                  <span>{{ formatDate(polizza.data_inizio) }}</span>
                  <span class="arrow">â†’</span>
                  <span>{{ formatDate(polizza.data_scadenza) }}</span>
                </div>
                <span [class]="'badge badge-sm ' + getScadenzaBadgeClass(polizza.stato_scadenza)">
                  {{ polizza.stato_scadenza }}
                </span>
              </div>
            </td>
            <td>
              <span [class]="'badge ' + getStatoBadgeClass(polizza.stato_polizza)">
                {{ polizza.stato_polizza }}
              </span>
            </td>
            <td class="currency">{{ formatCurrency(polizza.premio_annuale) }}</td>
            <td>
              <div class="massimale-cell">
                @if (polizza.massimale) {
                  <div class="massimale">
                    <strong>{{ formatCurrency(polizza.massimale) }}</strong>
                    <small>massimale</small>
                  </div>
                }
                @if (polizza.franchigia) {
                  <div class="franchigia">
                    <span>{{ formatCurrency(polizza.franchigia) }}</span>
                    <small>franchigia</small>
                  </div>
                }
              </div>
            </td>
            <td>
              <div class="utilizzo-cell">
                @if (polizza.numero_sinistri > 0) {
                  <div [class]="'utilizzo-indicator ' + getUtilizzoBadgeClass(polizza.percentuale_utilizzo)">
                    <span class="percentuale">{{ polizza.percentuale_utilizzo }}%</span>
                    <span class="importo">{{ formatCurrency(polizza.totale_liquidato) }}</span>
                    <small>{{ polizza.numero_sinistri }} sinistri</small>
                  </div>
                } @else {
                  <span class="no-utilizzo">Nessun sinistro</span>
                }
              </div>
            </td>
            <td>
              <div class="action-buttons">
                <button
                  class="btn btn-sm btn-info"
                  (click)="viewDetails(polizza)"
                  title="Visualizza dettagli">
                  <i class="icon-eye"></i>
                </button>
                <button
                  class="btn btn-sm btn-secondary"
                  (click)="openEditModal(polizza)"
                  title="Modifica">
                  <i class="icon-edit"></i>
                </button>
                <button
                  class="btn btn-sm btn-danger"
                  (click)="deletePolizza(polizza.id_polizza)"
                  title="Elimina">
                  <i class="icon-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="9" class="no-data">
              Nessuna polizza trovata
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Modal per Creazione/Modifica -->
  @if (isModalOpen()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ isEditing() ? 'Modifica Polizza' : 'Nuova Polizza' }}</h3>
          <button class="btn-close" (click)="closeModal()">&times;</button>
        </div>

        <form class="modal-body" (ngSubmit)="savePolizza()">
          <div class="form-row">
            <div class="form-group">
              <label for="numeroPolizza">Numero Polizza *</label>
              <div class="input-group">
                <input
                  id="numeroPolizza"
                  type="text"
                  [(ngModel)]="newPolizza.numero_polizza"
                  name="numeroPolizza"
                  required
                  class="form-control">
                @if (!isEditing()) {
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    (click)="onGenerateNumero()"
                    title="Genera numero automatico">
                    ðŸŽ²
                  </button>
                }
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="assicurato">Assicurato *</label>
              <select
                id="assicurato"
                [(ngModel)]="newPolizza.id_assicurato"
                name="assicurato"
                required
                class="form-control">
                <option value="0">Seleziona assicurato</option>
                @for (assicurato of assicurati(); track assicurato.id_assicurato) {
                  <option [value]="assicurato.id_assicurato">
                    {{ assicurato.nome_completo }} ({{ assicurato.codice_fiscale }})
                  </option>
                }
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="tipoPolizza">Tipo Polizza *</label>
              <select
                id="tipoPolizza"
                [(ngModel)]="newPolizza.id_tipo_polizza"
                name="tipoPolizza"
                required
                (change)="onTipoChange()"
                class="form-control">
                @for (tipo of tipiPolizza(); track tipo.id_tipo_polizza) {
                  <option [value]="tipo.id_tipo_polizza">
                    {{ tipo.descrizione }}
                  </option>
                }
              </select>
            </div>
            <div class="form-group">
              <label for="statoPolizza">Stato *</label>
              <select
                id="statoPolizza"
                [(ngModel)]="newPolizza.id_stato_polizza"
                name="statoPolizza"
                required
                class="form-control">
                @for (stato of statiPolizza(); track stato.id_stato_polizza) {
                  <option [value]="stato.id_stato_polizza">
                    {{ stato.descrizione }}
                  </option>
                }
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="dataInizio">Data Inizio *</label>
              <input
                id="dataInizio"
                type="date"
                [(ngModel)]="newPolizza.data_inizio"
                name="dataInizio"
                required
                class="form-control">
            </div>
            <div class="form-group">
              <label for="dataScadenza">Data Scadenza *</label>
              <input
                id="dataScadenza"
                type="date"
                [(ngModel)]="newPolizza.data_scadenza"
                name="dataScadenza"
                required
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="premioAnnuale">Premio Annuale (â‚¬) *</label>
              <input
                id="premioAnnuale"
                type="number"
                step="0.01"
                min="0"
                [(ngModel)]="newPolizza.premio_annuale"
                name="premioAnnuale"
                required
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="massimale">Massimale (â‚¬)</label>
              <input
                id="massimale"
                type="number"
                step="0.01"
                min="0"
                [(ngModel)]="newPolizza.massimale"
                name="massimale"
                class="form-control">
            </div>
            <div class="form-group">
              <label for="franchigia">Franchigia (â‚¬)</label>
              <input
                id="franchigia"
                type="number"
                step="0.01"
                min="0"
                [(ngModel)]="newPolizza.franchigia"
                name="franchigia"
                class="form-control">
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">
              Annulla
            </button>
            <button type="submit" class="btn btn-primary">
              {{ isEditing() ? 'Aggiorna' : 'Crea' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
