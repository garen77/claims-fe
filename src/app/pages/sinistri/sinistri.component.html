<div class="container">
  <div class="header">
    <h1>Gestione Sinistri</h1>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <i class="icon-plus"></i>
      Nuovo Sinistro
    </button>
  </div>

  <!-- Filtri -->
  <div class="filters">
    <div class="filter-group">
      <label for="search">Cerca:</label>
      <input
        id="search"
        type="text"
        placeholder="Numero, assicurato, descrizione..."
        [value]="searchTerm()"
        (input)="onSearchChange($event)"
        class="form-control">
    </div>

    <div class="filter-group">
      <label for="tipo">Tipo:</label>
      <select
        id="tipo"
        [value]="filterTipo()"
        (change)="onTipoFilterChange($event)"
        class="form-control">
        <option value="all">Tutti i tipi</option>
        @for (tipo of tipiSinistro(); track tipo.id_tipo_sinistro) {
          <option [value]="tipo.id_tipo_sinistro">{{ tipo.descrizione }}</option>
        }
      </select>
    </div>

    <div class="filter-group">
      <label for="stato">Stato:</label>
      <select
        id="stato"
        [value]="filterStato()"
        (change)="onStatoFilterChange($event)"
        class="form-control">
        <option value="all">Tutti gli stati</option>
        @for (stato of statiSinistro(); track stato.id_stato_sinistro) {
          <option [value]="stato.id_stato_sinistro">{{ stato.descrizione }}</option>
        }
      </select>
    </div>

    <div class="filter-group">
      <label for="priorita">Priorit√†:</label>
      <select
        id="priorita"
        [value]="filterPriorita()"
        (change)="onPrioritaFilterChange($event)"
        class="form-control">
        <option value="all">Tutte</option>
        <option value="1">Alta</option>
        <option value="2">Media</option>
        <option value="3">Bassa</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="operatore">Operatore:</label>
      <select
        id="operatore"
        [value]="filterOperatore()"
        (change)="onOperatoreFilterChange($event)"
        class="form-control">
        <option value="all">Tutti</option>
        @for (operatore of operatori(); track operatore.id_operatore) {
          <option [value]="operatore.id_operatore">{{ operatore.nome_completo }}</option>
        }
      </select>
    </div>
  </div>

  <!-- Tabella Sinistri -->
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>Numero</th>
          <th>Assicurato/Polizza</th>
          <th>Tipo/Priorit√†</th>
          <th>Data & Luogo</th>
          <th>Stato</th>
          <th>Importi</th>
          <th>Operatore</th>
          <th>Gestione</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody>
        @for (sinistro of filteredSinistri(); track sinistro.id_sinistro) {
          <tr>
            <td class="code">{{ sinistro.numero_sinistro }}</td>
            <td>
              <div class="assicurato-cell">
                <strong>{{ sinistro.assicurato }}</strong>
                <small>{{ sinistro.codice_fiscale }}</small>
                <span class="polizza-badge">{{ sinistro.numero_polizza }}</span>
              </div>
            </td>
            <td>
              <div class="tipo-cell">
                <span [class]="'badge ' + getTipoBadgeClass(sinistro.tipo_sinistro)">
                  {{ sinistro.tipo_sinistro }}
                </span>
                <span [class]="'badge badge-sm ' + getPrioritaBadgeClass(sinistro.priorita)">
                  {{ sinistro.priorita_desc }}
                </span>
              </div>
            </td>
            <td>
              <div class="data-cell">
                <div class="data-sinistro">
                  <strong>{{ formatDate(sinistro.data_sinistro) }}</strong>
                  <small>sinistro</small>
                </div>
                <div class="data-denuncia">
                  <span>{{ formatDate(sinistro.data_denuncia) }}</span>
                  <small>denuncia</small>
                </div>
                @if (sinistro.luogo_sinistro) {
                  <div class="luogo">
                    üìç {{ sinistro.luogo_sinistro }}
                  </div>
                }
              </div>
            </td>
            <td>
              <span
                [class]="'badge ' + getStatoBadgeClass(sinistro.stato_sinistro)"
                [style.background-color]="sinistro.colore_stato"
                [style.color]="'white'">
                {{ sinistro.stato_sinistro }}
              </span>
            </td>
            <td>
              <div class="importi-cell">
                @if (sinistro.importo_richiesto) {
                  <div class="importo-richiesto">
                    <span>{{ formatCurrency(sinistro.importo_richiesto) }}</span>
                    <small>richiesto</small>
                  </div>
                }
                @if (sinistro.importo_liquidato) {
                  <div class="importo-liquidato">
                    <strong>{{ formatCurrency(sinistro.importo_liquidato) }}</strong>
                    <small>liquidato ({{ sinistro.percentuale_liquidazione }}%)</small>
                  </div>
                }
                @if (!sinistro.importo_richiesto && !sinistro.importo_liquidato) {
                  <span class="no-data">-</span>
                }
              </div>
            </td>
            <td>
              @if (sinistro.operatore_assegnato) {
                <div class="operatore-cell">
                  <strong>{{ sinistro.operatore_assegnato }}</strong>
                  <small>{{ sinistro.ruolo_operatore }}</small>
                </div>
              } @else {
                <span class="no-assignment">Non assegnato</span>
              }
            </td>
            <td>
              <div class="gestione-cell">
                <div [class]="'giorni-gestione ' + getDaysClass(sinistro.giorni_gestione)">
                  <span class="giorni-numero">{{ sinistro.giorni_gestione }}</span>
                  <span class="giorni-label">giorni</span>
                </div>
                @if (sinistro.data_chiusura) {
                  <small class="data-chiusura">
                    Chiuso: {{ formatDate(sinistro.data_chiusura) }}
                  </small>
                }
                <div class="activity-stats">
                  @if (sinistro.numero_perizie > 0) {
                    <span class="stat-badge">{{ sinistro.numero_perizie }} perizie</span>
                  }
                  @if (sinistro.numero_pagamenti > 0) {
                    <span class="stat-badge">{{ sinistro.numero_pagamenti }} pagamenti</span>
                  }
                </div>
              </div>
            </td>
            <td>
              <div class="action-buttons">
                <button
                  class="btn btn-sm btn-info"
                  (click)="viewDetails(sinistro)"
                  title="Visualizza dettagli">
                  <i class="icon-eye"></i>
                </button>
                <button
                  class="btn btn-sm btn-secondary"
                  (click)="openEditModal(sinistro)"
                  title="Modifica">
                  <i class="icon-edit"></i>
                </button>
                <button
                  class="btn btn-sm btn-danger"
                  (click)="deleteSinistro(sinistro.id_sinistro)"
                  title="Elimina">
                  <i class="icon-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="9" class="no-data">
              Nessun sinistro trovato
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Modal per Creazione/Modifica -->
  @if (isModalOpen()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ isEditing() ? 'Modifica Sinistro' : 'Nuovo Sinistro' }}</h3>
          <button class="btn-close" (click)="closeModal()">&times;</button>
        </div>

        <form class="modal-body" (ngSubmit)="saveSinistro()">
          <div class="form-row">
            <div class="form-group">
              <label for="numeroSinistro">Numero Sinistro *</label>
              <div class="input-group">
                <input
                  id="numeroSinistro"
                  type="text"
                  [(ngModel)]="newSinistro.numero_sinistro"
                  name="numeroSinistro"
                  required
                  class="form-control">
                @if (!isEditing()) {
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    (click)="onGenerateNumero()"
                    title="Genera numero automatico">
                    üé≤
                  </button>
                }
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="polizza">Polizza *</label>
              <select
                id="polizza"
                [(ngModel)]="newSinistro.id_polizza"
                name="polizza"
                required
                class="form-control">
                <option value="0">Seleziona polizza</option>
                @for (polizza of polizze(); track polizza.id_polizza) {
                  <option [value]="polizza.id_polizza">
                    {{ polizza.numero_polizza }} - {{ polizza.assicurato }} ({{ polizza.tipo_polizza }})
                  </option>
                }
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="dataSinistro">Data Sinistro *</label>
              <input
                id="dataSinistro"
                type="date"
                [(ngModel)]="newSinistro.data_sinistro"
                name="dataSinistro"
                required
                class="form-control">
            </div>
            <div class="form-group">
              <label for="dataDenuncia">Data Denuncia</label>
              <input
                id="dataDenuncia"
                type="datetime-local"
                [(ngModel)]="newSinistro.data_denuncia"
                name="dataDenuncia"
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="tipoSinistro">Tipo Sinistro *</label>
              <select
                id="tipoSinistro"
                [(ngModel)]="newSinistro.id_tipo_sinistro"
                name="tipoSinistro"
                required
                class="form-control">
                @for (tipo of tipiSinistro(); track tipo.id_tipo_sinistro) {
                  <option [value]="tipo.id_tipo_sinistro">
                    {{ tipo.descrizione }}
                  </option>
                }
              </select>
            </div>
            <div class="form-group">
              <label for="statoSinistro">Stato *</label>
              <select
                id="statoSinistro"
                [(ngModel)]="newSinistro.id_stato_sinistro"
                name="statoSinistro"
                required
                class="form-control">
                @for (stato of statiSinistro(); track stato.id_stato_sinistro) {
                  <option [value]="stato.id_stato_sinistro">
                    {{ stato.descrizione }}
                  </option>
                }
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="priorita">Priorit√† *</label>
              <select
                id="priorita"
                [(ngModel)]="newSinistro.priorita"
                name="priorita"
                required
                class="form-control">
                <option value="1">Alta</option>
                <option value="2">Media</option>
                <option value="3">Bassa</option>
              </select>
            </div>
            <div class="form-group">
              <label for="operatoreAssegnato">Operatore Assegnato</label>
              <select
                id="operatoreAssegnato"
                [(ngModel)]="newSinistro.id_operatore_assegnato"
                name="operatoreAssegnato"
                class="form-control">
                <option value="0">Nessuno</option>
                @for (operatore of operatori(); track operatore.id_operatore) {
                  <option [value]="operatore.id_operatore">
                    {{ operatore.nome_completo }} ({{ operatore.ruolo }})
                  </option>
                }
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="luogoSinistro">Luogo Sinistro</label>
              <input
                id="luogoSinistro"
                type="text"
                [(ngModel)]="newSinistro.luogo_sinistro"
                name="luogoSinistro"
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="descrizione">Descrizione *</label>
              <textarea
                id="descrizione"
                [(ngModel)]="newSinistro.descrizione"
                name="descrizione"
                required
                rows="3"
                class="form-control"></textarea>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="importoRichiesto">Importo Richiesto (‚Ç¨)</label>
              <input
                id="importoRichiesto"
                type="number"
                step="0.01"
                min="0"
                [(ngModel)]="newSinistro.importo_richiesto"
                name="importoRichiesto"
                class="form-control">
            </div>
            <div class="form-group">
              <label for="importoLiquidato">Importo Liquidato (‚Ç¨)</label>
              <input
                id="importoLiquidato"
                type="number"
                step="0.01"
                min="0"
                [(ngModel)]="newSinistro.importo_liquidato"
                name="importoLiquidato"
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="note">Note</label>
              <textarea
                id="note"
                [(ngModel)]="newSinistro.note"
                name="note"
                rows="3"
                class="form-control"></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">
              Annulla
            </button>
            <button type="submit" class="btn btn-primary">
              {{ isEditing() ? 'Aggiorna' : 'Crea' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
