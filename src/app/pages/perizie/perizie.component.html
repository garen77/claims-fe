<div class="container">
  <div class="header">
    <h1>Gestione Perizie</h1>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <i class="icon-plus"></i>
      Nuova Perizia
    </button>
  </div>

  <!-- Filtri -->
  <div class="filters">
    <div class="filter-group">
      <label for="search">Cerca:</label>
      <input
        id="search"
        type="text"
        placeholder="Sinistro, assicurato, perito..."
        [value]="searchTerm()"
        (input)="onSearchChange($event)"
        class="form-control">
    </div>

    <div class="filter-group">
      <label for="tipo">Tipo:</label>
      <select
        id="tipo"
        [value]="filterTipo()"
        (change)="onTipoFilterChange($event)"
        class="form-control">
        <option value="all">Tutti i tipi</option>
        @for (tipo of tipiPerizia(); track tipo.id_tipo_perizia) {
          <option [value]="tipo.id_tipo_perizia">{{ tipo.descrizione }}</option>
        }
      </select>
    </div>

    <div class="filter-group">
      <label for="esito">Esito:</label>
      <select
        id="esito"
        [value]="filterEsito()"
        (change)="onEsitoFilterChange($event)"
        class="form-control">
        <option value="all">Tutti gli esiti</option>
        @for (esito of esitiPerizia(); track esito.id_esito_perizia) {
          <option [value]="esito.id_esito_perizia">{{ esito.descrizione }}</option>
        }
      </select>
    </div>

    <div class="filter-group">
      <label for="operatore">Perito:</label>
      <select
        id="operatore"
        [value]="filterOperatore()"
        (change)="onOperatoreFilterChange($event)"
        class="form-control">
        <option value="all">Tutti</option>
        @for (operatore of operatori(); track operatore.id_operatore) {
          <option [value]="operatore.id_operatore">{{ operatore.nome_completo }}</option>
        }
      </select>
    </div>

    <div class="filter-group">
      <label for="periodo">Periodo:</label>
      <select
        id="periodo"
        [value]="filterPeriodo()"
        (change)="onPeriodoFilterChange($event)"
        class="form-control">
        <option value="all">Tutte</option>
        <option value="ultima_settimana">Ultima settimana</option>
        <option value="ultimo_mese">Ultimo mese</option>
        <option value="ultimo_trimestre">Ultimo trimestre</option>
      </select>
    </div>
  </div>

  <!-- Tabella Perizie -->
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>Sinistro</th>
          <th>Perito</th>
          <th>Data/Tipo</th>
          <th>Esito</th>
          <th>Valutazione</th>
          <th>Relazione</th>
          <th>Allegati</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody>
        @for (perizia of filteredPerizie(); track perizia.id_perizia) {
          <tr>
            <td>
              <div class="sinistro-cell">
                <strong class="numero-sinistro">{{ perizia.numero_sinistro }}</strong>
                <div class="assicurato-info">
                  <span>{{ perizia.assicurato }}</span>
                  <small>{{ perizia.numero_polizza }}</small>
                </div>
                <div class="sinistro-details">
                  <span class="tipo-sinistro">{{ perizia.tipo_sinistro }}</span>
                  <small class="data-sinistro">{{ formatDate(perizia.data_sinistro) }}</small>
                </div>
              </div>
            </td>
            <td>
              <div class="perito-cell">
                <strong>{{ perizia.perito }}</strong>
                <small>{{ perizia.ruolo_perito }}</small>
                <span class="codice-operatore">{{ perizia.codice_operatore }}</span>
              </div>
            </td>
            <td>
              <div class="data-tipo-cell">
                <div class="data-perizia">
                  <strong>{{ formatDate(perizia.data_perizia) }}</strong>
                  <small>Data perizia</small>
                </div>
                <span [class]="'badge ' + getTipoBadgeClass(perizia.tipo_perizia)">
                  {{ perizia.tipo_perizia }}
                </span>
              </div>
            </td>
            <td>
              <div class="esito-cell">
                <span [class]="'badge ' + getEsitoBadgeClass(perizia.esito_perizia, perizia.esito_favorevole)">
                  {{ perizia.esito_perizia }}
                </span>
                @if (perizia.esito_favorevole !== undefined) {
                  <div class="favorevole-indicator">
                    @if (perizia.esito_favorevole) {
                      <span class="favorevole">âœ“ Favorevole</span>
                    } @else {
                      <span class="sfavorevole">âœ— Sfavorevole</span>
                    }
                  </div>
                }
              </div>
            </td>
            <td>
              <div class="valutazione-cell">
                @if (perizia.importo_stimato) {
                  <div class="importo-stimato">
                    <strong>{{ formatCurrency(perizia.importo_stimato) }}</strong>
                    <small>stimato</small>
                  </div>
                }
                @if (perizia.importo_richiesto) {
                  <div class="importo-richiesto">
                    <span>{{ formatCurrency(perizia.importo_richiesto) }}</span>
                    <small>richiesto</small>
                  </div>
                }
                @if (perizia.percentuale_stima_su_richiesto > 0) {
                  <div class="percentuale-container">
                    <div
                      class="percentuale-bar"
                      [style]="getGradientStyle(perizia.percentuale_stima_su_richiesto)">
                      <span class="percentuale-text">{{ perizia.percentuale_stima_su_richiesto }}%</span>
                    </div>
                  </div>
                }
              </div>
            </td>
            <td>
              <div class="relazione-cell">
                @if (perizia.relazione) {
                  <div class="relazione-preview">
                    {{ truncateText(perizia.relazione, 100) }}
                  </div>
                  <button
                    class="btn btn-sm btn-outline-info"
                    (click)="viewDetails(perizia)"
                    title="Leggi relazione completa">
                    Leggi tutto
                  </button>
                } @else {
                  <span class="no-data">Nessuna relazione</span>
                }
              </div>
            </td>
            <td>
              <div class="allegati-cell">
                @if (countAllegati(perizia.allegati) > 0) {
                  <div class="allegati-info">
                    <span class="allegati-count">ðŸ“Ž {{ countAllegati(perizia.allegati) }}</span>
                    <small>file allegati</small>
                  </div>
                  @if (perizia.allegati) {
                    <div class="allegati-list">
                      @for (allegato of perizia.allegati.split(','); track allegato) {
                        <small class="allegato-item">{{ allegato.trim() }}</small>
                      }
                    </div>
                  }
                } @else {
                  <span class="no-data">Nessun allegato</span>
                }
              </div>
            </td>
            <td>
              <div class="action-buttons">
                <button
                  class="btn btn-sm btn-info"
                  (click)="viewDetails(perizia)"
                  title="Visualizza dettagli">
                  <i class="icon-eye"></i>
                </button>
                <button
                  class="btn btn-sm btn-secondary"
                  (click)="openEditModal(perizia)"
                  title="Modifica">
                  <i class="icon-edit"></i>
                </button>
                <button
                  class="btn btn-sm btn-danger"
                  (click)="deletePerizia(perizia.id_perizia)"
                  title="Elimina">
                  <i class="icon-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="8" class="no-data">
              Nessuna perizia trovata
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Modal per Creazione/Modifica -->
  @if (isModalOpen()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ isEditing() ? 'Modifica Perizia' : 'Nuova Perizia' }}</h3>
          <button class="btn-close" (click)="closeModal()">&times;</button>
        </div>

        <form class="modal-body" (ngSubmit)="savePerizia()">
          <div class="form-row">
            <div class="form-group">
              <label for="sinistro">Sinistro *</label>
              <select
                id="sinistro"
                [(ngModel)]="newPerizia.id_sinistro"
                name="sinistro"
                required
                class="form-control">
                <option value="0">Seleziona sinistro</option>
                @for (sinistro of sinistri(); track sinistro.id_sinistro) {
                  <option [value]="sinistro.id_sinistro">
                    {{ sinistro.numero_sinistro }} - {{ sinistro.assicurato }} ({{ sinistro.tipo_sinistro }})
                  </option>
                }
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="operatore">Perito *</label>
              <select
                id="operatore"
                [(ngModel)]="newPerizia.id_operatore"
                name="operatore"
                required
                class="form-control">
                <option value="0">Seleziona perito</option>
                @for (operatore of operatori(); track operatore.id_operatore) {
                  <option [value]="operatore.id_operatore">
                    {{ operatore.nome_completo }} ({{ operatore.ruolo }})
                  </option>
                }
              </select>
            </div>
            <div class="form-group">
              <label for="dataPerizia">Data Perizia *</label>
              <input
                id="dataPerizia"
                type="date"
                [(ngModel)]="newPerizia.data_perizia"
                name="dataPerizia"
                required
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="tipoPerizia">Tipo Perizia *</label>
              <select
                id="tipoPerizia"
                [(ngModel)]="newPerizia.id_tipo_perizia"
                name="tipoPerizia"
                required
                class="form-control">
                @for (tipo of tipiPerizia(); track tipo.id_tipo_perizia) {
                  <option [value]="tipo.id_tipo_perizia">
                    {{ tipo.descrizione }}
                  </option>
                }
              </select>
            </div>
            <div class="form-group">
              <label for="esitoPerizia">Esito *</label>
              <select
                id="esitoPerizia"
                [(ngModel)]="newPerizia.id_esito_perizia"
                name="esitoPerizia"
                required
                class="form-control">
                @for (esito of esitiPerizia(); track esito.id_esito_perizia) {
                  <option [value]="esito.id_esito_perizia">
                    {{ esito.descrizione }}
                  </option>
                }
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="importoStimato">Importo Stimato (â‚¬)</label>
              <input
                id="importoStimato"
                type="number"
                step="0.01"
                min="0"
                [(ngModel)]="newPerizia.importo_stimato"
                name="importoStimato"
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="relazione">Relazione</label>
              <textarea
                id="relazione"
                [(ngModel)]="newPerizia.relazione"
                name="relazione"
                rows="4"
                placeholder="Descrizione dettagliata della perizia..."
                class="form-control"></textarea>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="allegati">Allegati</label>
              <input
                id="allegati"
                type="text"
                [(ngModel)]="newPerizia.allegati"
                name="allegati"
                placeholder="file1.pdf,file2.jpg (separati da virgola)"
                class="form-control">
              <small class="form-text">Inserire i nomi dei file separati da virgola</small>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">
              Annulla
            </button>
            <button type="submit" class="btn btn-primary">
              {{ isEditing() ? 'Aggiorna' : 'Crea' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
